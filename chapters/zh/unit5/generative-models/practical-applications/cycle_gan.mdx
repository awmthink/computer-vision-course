# CycleGAN 介绍

本节介绍了 CycleGAN，即 *Cycle-Consistent Generative Adversarial Network* 的缩写，它是一种设计用于图像到图像转换任务的框架，在这些任务中，没有成对的图像示例可用。该框架由 Zhu 等人在 [2017](https://arxiv.org/abs/1703.10593) 的一篇论文中提出，是计算机视觉和机器学习领域的一项重大进展。

在许多图像到图像的转换任务中，目标是学习一个从输入图像到输出图像的映射。传统的方法通常依赖于大量成对的图像数据集（例如，照片和相应的素描）。然而，获取这样的成对数据集在很多情况下极其困难，甚至不可行。而 CycleGAN 的设计初衷正是为了解决这一问题，使得它可以处理无成对数据集的场景。

## 什么是无配对图像到图像转换
<div class="flex justify-center">
    <img src="https://huggingface.co/datasets/hf-vision/course-assets/resolve/main/unpaired_images.png" alt="paired and unpaired_images">
<p>图1：paired and unpaired_images</p>
</div>

在许多图像转换场景中，我们会遇到缺乏图像对之间一对一对应的数据集的情况。这种情况就涉及到无配对图像到图像的转换。在这里，不是拥有成对的图像，而是有两个不同的图像集或“堆”，每个图像集代表不同的风格或领域，例如 X 和 Y。比如，一个图像集可能包含真实的照片，而另一个图像集可能包含莫奈、塞尚等艺术家的画作。又或者，这些图像集代表不同的季节，一个展示冬季风景，另一个展示夏季风景。再例如，一个图像集中包含马的图片，另一个则包含斑马的图片，但两者之间没有直接配对关系。无配对图像到图像转换的目标是让模型学习并提取每个图像集的风格特征，然后应用这些风格来将一个领域的图像转换为另一个领域的图像。这种转换通常是双向的，使得可以将 X 域的图像转换为 Y 域的风格，反之亦然。当精确的图像对不可用或难以获取时，这种方法尤为宝贵。

## CycleGAN 的主要组件

**双重 GAN 结构**：

CycleGAN 使用两个 GAN（生成对抗网络），一个用于从第一个图像集转换到第二个图像集（例如，斑马到马），另一个用于反向过程（马到斑马）。这种双重结构确保了真实性（通过对抗过程）和内容保留（通过循环一致性）。
   - PatchGAN 判别器：CycleGAN 中使用的判别器基于 [PatchGAN](https://arxiv.org/pdf/1611.07004.pdf) 架构，该架构评估图像的局部区域而非整个图像，从而有助于更加细致和局部化的真实性。
   - 生成器架构：CycleGAN 的生成器借鉴了 [U-Net](https://arxiv.org/abs/1505.04597) 和 [DCGAN](https://arxiv.org/abs/1511.06434) 的架构，包含下采样（编码）、上采样（解码）、以及带有批归一化和 ReLU 的卷积层。生成器通过增加卷积层和跳跃连接（即残差连接）得到增强，有助于学习恒等函数并支持更深层的转换。

**循环一致性损失**：

确保图像的风格可以改变（例如，从悲伤表情到拥抱表情），然后可以恢复到其原始形式（从拥抱表情恢复到悲伤表情），且细节或内容的损失最小。

实现包括两个阶段的转换。

**第一阶段**：将悲伤表情转换为拥抱表情。**第二阶段**：将拥抱表情再转换回悲伤表情。模型的目标是使最终的图像（恢复后的悲伤表情）尽可能接近原始的悲伤表情。这是通过最小化这两幅图像之间的像素差异来实现的，并将该差异加入到模型的损失函数中。循环一致性在两个方向上都得以应用：从悲伤表情到拥抱表情再到悲伤表情，以及从拥抱表情到悲伤表情再到拥抱表情。每个循环的损失通过求和像素差异来计算，并整合到总体的生成器损失中。
与对抗性损失的结合：循环一致性损失与 GAN 中常用的对抗性损失相结合，形成了一个综合的损失函数。该综合损失函数同时优化 CycleGAN 中的两个生成器。

**最小二乘损失**：

它是一种最小化残差平方和的方法。这意味着它试图找到一条最佳拟合线，使得该线与所有点之间的平方距离和最小。在 GAN 中，**线**代表标签（真实或假），而点代表判别器的预测。在最小二乘对抗性损失中，判别器的损失函数通过计算其预测与实际标签（真实或假）之间的平方距离来计算跨多个图像的误差。对于生成器来说，损失函数设计为使其伪造输出尽可能看起来是真实的，通过测量这些输出与“真实”标签的偏离程度来衡量。最小二乘损失解决了在 BCE 损失中常见的梯度消失和模式崩溃问题。

**恒等损失**：

CycleGAN 中引入的恒等损失是一种可选的损失项，旨在增强生成图像的色彩保留效果。它通过确保一个图像输入到生成器中（例如，将一张马的图片输入到斑马到马的生成器）应当理想地输出相同的图像，因为该图像已经在目标风格中。该损失计算为真实输入和生成器输出之间的像素距离。零像素距离（即图像没有变化）导致零恒等损失，这是期望的结果。
对于 CycleGAN 的生成器，此损失与对抗性和循环一致性损失一同加入。该损失通过一个 lambda 项（权重因子）进行调整。

<div class="flex justify-center">
    <img src="https://huggingface.co/datasets/hf-vision/course-assets/resolve/main/cycleGAN1.jpg" alt="CycleGAN">
<p>图2：CycleGAN</p>
</div>
此图显示了两个 **GAN** 的组合架构功能。这些 GAN 通过循环一致性连接，形成一个循环。
对于真实图像，分类矩阵包含一。对于伪造图像，包含零。总之，CycleGAN 精细地结合了两个 GAN 以及各种损失函数，包括对抗性、循环一致性和可选的恒等损失，从而能够有效地在两个领域之间传递风格，同时保留输入图像的基本特征。